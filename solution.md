##### Задание 1

with count_diff as(
	select u.id, 
	to_char(u.date_joined, 'YYYY-MM') as dt_reg, --Преобразование даты регистрации, помесячно
	(date(u2.entry_at) - date(u.date_joined))::numeric as diff	--Количество дней между регистрацией и первым входом diff 
	from users u
	join userentry u2 
	on u.id = u2.user_id),
--Рассчёт помесячно по дате регистрации сколько пользователей проявили активность после регистрации  
--в интервале 0,1,3,7,14,30,60 и 90 дней  
count_user as (select 
	dt_reg, 
	count(distinct case when diff >= 0 then id else null end) as days_0,
	count(distinct case when diff >= 1 then id else null end) as days_1,
	count(distinct case when diff >= 3 then id else null end) as days_3,
	count(distinct case when diff >= 7 then id else null end) as days_7,
	count(distinct case when diff >= 14 then id else null end) as days_14,
	count(distinct case when diff >= 30 then id else null end) as days_30,
	count(distinct case when diff >= 60 then id else null end) as days_60,
	count(distinct case when diff >= 90 then id else null end) as days_90
	from count_diff
	group by dt_reg
	order by dt_reg)
--Расчет результата в процентах, с точностью до 2-х знаков
--Общее число зарегистрировавшихся это  days_0
select dt_reg,
	round(days_0::numeric/days_0 * 100, 2) as days_0,
	round(days_1::numeric/days_0 * 100, 2) as days_1,
	round(days_3::numeric/days_0 * 100, 2) as days_3,
	round(days_7::numeric/days_0 * 100, 2) as days_7,
	round(days_14::numeric/days_0 * 100, 2) as days_14,
	round(days_30::numeric/days_0 * 100, 2) as days_30,
	round(days_60::numeric/days_0 * 100, 2) as days_60,
	round(days_90::numeric/days_0 * 100, 2) as days_90
from count_user

Выводы:
Анализ данных показал следующие тенденции:
1.Активность  на 0-й день близок к 100%. В первый день пользователи регистрируются и знакомятся с курсом.
2.К 7-му дню наблюдается значительное падение активности. Студенты приступают к изучению теоретической части программы курса.  
3. К 30-му дню активность стабилизируется, что говорит о том, что студенты для закрепления полученных знаний перешли к решению практических задач.
4. После 60-90 дней активность значительно снижается. Большинство студентов решили задачи практического курса. Остались лояльные пользователи решающие бонусные задачи.
Оптимальный срок тарифа: 
Наибольшая активность наблюдается в первые 30 дней. После этого периода активность резко падает,  Что делает месячный тариф оптимальным.
•	Короткий срок (1 месяц) соответствует пику активности.
•	Длинные тарифы (60-90 дней) менее выгодны из-за низкой активности.
 

 
#### Задание 2

with count_deb_accr as(
	select 
	sum(case when t.type_id in(1,23,24,25,26,27,28,30) then value else 0 end) as debiting, --Расчёт списаний
	sum(case when t.type_id  not in(1,23,24,25,26,27,28,30) then value else 0 end) as accruals --Расчёт начислений
	from transaction t
	group by user_id)
select	
	round(avg(accruals), 0) as avg_accruals, --среднее начисление
	round(avg(debiting), 0) as avg_debiting, --среднее списание
	round(avg(accruals - debiting), 0) as avg_balance, --средний баланс
	percentile_cont(0.5) within group(order by(accruals - debiting)) as median_balance --медианный баланс
from count_deb_accr

--Среднее начисление 307
--Среднее списание 31 
--Средний баланс 275
--Медианный баланс 62

Анализ метрик баланса пользователей
1.	Среднее начисление: 307 коинов
o	Это значение показывает, сколько в среднем коинов получает один пользователь. Оно значительно превышает средний расход, что  указывает на общий рост балансов пользователей.
2.	Среднее списание: 31 коин
o	Средний расход коинов существенно ниже среднего начисления. Это  означает, что пользователи либо не активно тратят коины, либо имеют ограниченные возможности для их использования.
3.	Средний баланс: 275 коинов
o	В среднем у пользователей достаточно высокий баланс, что подтверждает  накопление коинов из-за низких расходов.
4.	Медианный баланс: 62 коина
o	Значение медианного баланса значительно ниже среднего. Это говорит о сильной асимметрии в распределении балансов — у небольшой части пользователей накоплены большие суммы, тогда как у большинства баланс ниже среднего.
Выводы:
•	Начисления коинов значительно превышает их расход.
•	Низкий медианный баланс по сравнению со средним указывает на неравномерность распределения коинов: большинство пользователей имеют относительно небольшие суммы, а крупные балансы сосредоточены у меньшинства.
•	Для стимулирования активного использования коинов, стоит стимулировать траты.
Как повысить активность расходования коинов пользователями
1. Создание новых стимулов для расходов
•	доступ к дополнительным материалам.
•	Ограниченные предложения – временные акции, скидки и спецпредложения.
2. Ограничение накопления коинов
•	Срок годности коинов – введение механики сгорания коинов через определенный срок, если они не используются.
•	Ограничение максимального баланса – пользователи не могут накапливать больше определенного количества коинов, что стимулирует их тратить.
3. Стимулирование расходов
•	Эксклюзивные преимущества – доступ к премиум-контенту, ранний доступ к новым возможностям или персонализированные предложения за оплату.
•	Бонус за траты – кэшбэк.
Вывод
Для повышения активности расходования коинов необходимо ограничение накопления, увеличение ценности расходов. Ограничение накопления и временные акции помогут поддерживать баланс между начислением и расходом.


#### Задание 3

WITH solved_tasks AS (
    SELECT user_id, COUNT(DISTINCT problem_id) AS task_count  --Расчёт сколько решает задач пользователь
    FROM codesubmit
    WHERE is_false = 0
    GROUP BY user_id
),
started_tests AS (
    SELECT user_id, COUNT(DISTINCT test_id) AS test_count --Расчёт сколько тестов проходит пользователь 
    FROM teststart
    GROUP BY user_id
),
attempts_per_task AS (
    SELECT user_id, problem_id, COUNT(*) AS attempts --Расчёт сколько попыток делает пользователь для решения 1 задачи
    FROM codesubmit
    GROUP BY user_id, problem_id
),
attempts_per_test AS (
    SELECT user_id, test_id, COUNT(*) AS attempts --Расчёт сколько попыток делает пользователь для прохождения 1 теста
    FROM teststart
    GROUP BY user_id, test_id
),
active_users AS (
    SELECT user_id FROM coderun
    UNION
    SELECT user_id FROM codesubmit
    UNION
    SELECT user_id FROM teststart
),
all_users AS (
    SELECT COUNT(id) AS total_users FROM users u  -- все зарегистрированные пользователи
)
SELECT    
    avg((SELECT ROUND(AVG(task_count), 2) FROM solved_tasks))AS avg_tasks_per_user, --Расчёт сколько в среднем пользователь решает задач
    avg((SELECT ROUND(AVG(test_count), 2) FROM started_tests)) AS avg_tests_per_user, --Расчёт сколько в среднем пользователь проходит тестов
    avg((SELECT ROUND(AVG(attempts), 2) FROM attempts_per_task)) AS avg_attempts_per_task, --Расчёт сколько в среднем пользователь делает попыток для решения 1 задачи
    avg((SELECT ROUND(AVG(attempts), 2) FROM attempts_per_test)) AS avg_attempts_per_test, --Расчёт сколько в среднем пользователь делает попыток для прохождения 1 теста
    ROUND(
        (SELECT COUNT(DISTINCT user_id) FROM active_users)::numeric / 
        (SELECT total_users FROM all_users)::numeric,
    4
)*100 AS active_users_ratio_percent --Расчёт доли от общего числа пользователей решала хотя бы одну задачу или начинала проходить хотя бы один тест в %
from active_users

Выводы:
1.	Среднее количество решенных задач пользователем  11 (10,53).
Количество попыток на решение 1 задачи 3 (2,9)
Это говорит о высокой вовлеченности пользователей. Задачи достаточно интересны. Разнообразны: от простых к сложным. Имеются рекомендации, подсказки и примеры решения. После решения задачи пользователю предоставляется доступ к разбору варианта решения задачи. Для продвинутых пользователей есть дополнительно выбор сложных задач.
2.	Среднее количество пройденных тестов 2 (1,68)
Количество попыток на прохождения 1 теста 1,26
Тесты проходят 1-2 попыток. Это означает что, теоретический материал достаточно хорошо изложен преподавателем, и студент достаточно легко закрепляет полученные знания при прохождении теста.
3.	63,48% от общего числа пользователей решала хотя бы одну задачу или начинала проходить хотя бы один тест.


 
 
 
 
 
 
